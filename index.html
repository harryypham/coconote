<!DOCTYPE>
<html style="display: none;">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Collaborative Text Editor</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/abcjs-audio.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.8.0/gsap.min.js" integrity="sha512-eP6ippJojIKXKO8EPLtsUMS+/sAGHGo1UN/38swqZa1ypfcD4I0V/ac5G3VzaHfDaklFmQLEs51lhkkVaqg60Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="js/abcjs-basic.js" type="text/javascript"></script>
  </head>
  <body>
    <header class="position-fixed">
      <img src="img/logo-coconote.png" alt="Logo Coconote" id="logo">
    </header>
    <main>
      
      <div id="user_list"></div>
      
      
      <h1 class="text-center linear-wipe" id="modern-abc-editor">COCONOTE</h1>
      <div class="container d-flex justify-content-center align-items-stretch position-relative" id="big-container">
        <div class="container h-100 d-flex flex-column justify-content-start align-items-stretch" id="editor-and-scale">
          <textarea class="position-relative" id="abc" cols="80" rows="15" spellcheck="false" onInput="auto_grow(this)">
X: 1
T: Cooley's
M: 4/4
L: 1/8
R: reel
K: Emin
|:D2|EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|
EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|
|:gf|eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|
eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2:|
EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|
          </textarea>
          <div class="w-100 container" id="documentation-container">
            <button onClick="window.open('http://www.lesession.co.uk/abc/abc_notation.htm')" class="w-100">Documentation</button>
          </div>
          <div class="w-100 container" id="test-container">
            <button onClick="displayParticipant()" class="w-100" id="user_list_display_btn">View participants</button>
            <div id="user_list_all_container" class="position-fixed vw-100 vh-100 justify-content-center align-items-center">
              <div id="user_list_all" class="d-flex flex-column align-items-center justify-content-center">
                <h3>Participants</h3>
                <button onClick="hideParticipant()" id="user_list_hide_btn">Done</button>
                <div id="participants" class="d-flex flex-column align-items-center justify-content-center">
      
                </div>
              </div>
            </div>
          </div>
          <div class="w-100 container" id="collaborate-container">
            <button id="collaborate-btn" class="w-100" onClick="displayLink()">Collaborate</button>
            <div class="position-fixed vw-100 vh-100 justify-content-center align-items-center" id="collab-popup-container">
              <div id="collab-popup" class="d-flex flex-column align-items-center justify-content-center">
                <p>Copy this link and share with others: </p>
                <div id="collab-link-and-btn" class="d-flex">
                  <input id="collab-link" value="Error" readonly>
                  <button id="collab-link-btn" data-clipboard-target="#collab-link">
                    <img src="img/iconmonstr-copy-2.svg" alt="no">
                  </button> 
                </div>
                <button id="collab-done-btn" onClick="hiddenLink()">Done</button>
              </div>
            </div>
          </div>
          <div class="container w-100 d-flex flex-column align-items-center" id="dropdown-scale">
            <div class="dropdown w-100">
              <button
                class="btn btn-primary w-100 h-100"
                type="button"
                data-toggle="dropdown"
              >
                Scale Examples <span class="caret"></span>
              </button>
              <ul class="dropdown-menu">
                <li class="dropdown-header">Major scales</li>
                <li><a onClick="display('img/A.png')">A</a></li>
                <li><a onClick="display('img/Ab.png')">Ab</a></li>
                <li><a onClick="display('img/B.png')">B</a></li>
                <li><a onClick="display('img/Bb.png')">Bb</a></li>
                <li><a onClick="display('img/C_.png')">C#</a></li>
                <li><a onClick="display('img/C.png')">C</a></li>
                <li><a onClick="display('img/Cb.png')">Cb</a></li>
                <li><a onClick="display('img/D.png')">D</a></li>
                <li><a onClick="display('img/Db.png')">Db</a></li>
                <li><a onClick="display('img/E.png')">E</a></li>
                <li><a onClick="display('img/Eb.png')">Eb</a></li>
                <li><a onClick="display('img/F_.png')">F#</a></li>
                <li><a onClick="display('img/F.png')">F</a></li>
                <li><a onClick="display('img/G.png')">G</a></li>
                <li><a onClick="display('img/Gb.png')">Gb</a></li>
                <li class="dropdown-header">Natural minor scales</li>
                <li><a onClick="display('img/A_m.png')">A#m</a></li>
                <li><a onClick="display('img/Abm.png')">Abm</a></li>
                <li><a onClick="display('img/Am.png')">Am</a></li>
                <li><a onClick="display('img/Bbm.png')">Bbm</a></li>
                <li><a onClick="display('img/Bm.png')">Bm</a></li>
                <li><a onClick="display('img/C_m.png')">C#m</a></li>
                <li><a onClick="display('img/Cm.png')">Cm</a></li>
                <li><a onClick="display('img/D_m.png')">D#m</a></li>
                <li><a onClick="display('img/Dm.png')">Dm</a></li>
                <li><a onClick="display('img/Ebm.png')">Ebm</a></li>
                <li><a onClick="display('img/Em.png')">Em</a></li>
                <li><a onClick="display('img/F_m.png')">F#m</a></li>
                <li><a onClick="display('img/Fm.png')">Fm</a></li>
                <li><a onClick="display('img/G_m.png')">G#m</a></li>
                <li><a onClick="display('img/Gm.png')">Gm</a></li>
              </ul>
            </div>
            <img src="" alt="scale" style="display: none;" id="scale-img" />
          </div>
          
        </div>
        <div class="container d-flex flex-column align-items-start justify-content-start" id="paper-and-play">
          <div class="" id="paper"></div>
          <div class="container d-flex flex-column align-self-start justify-self-end" id="play-and-download">
            <div class="w-100 h-0 d-block align-self-end" id="audio"></div>
            <button id="midi" class="w-100">Download</button>
            <a id="midi-download" download="example.mid"></a>
          </div>
        </div>
        
        
      </div>
      
    </main>
    <script src="https://js.pusher.com/4.0/pusher.min.js"></script>
    <script type="text/javascript" src="js/app.js"></script>
    <script>
      gsap.from('#modern-abc-editor',{opacity: 0, duration: 1, y: -100})
      gsap.from('#logo',{opacity: 0,duration: 1, x: -50})
      gsap.from('#abc',{opacity: 0.3, duration: 1.5, x: -300})
      gsap.from('#documentation-container',{opacity: 0.3, delay:0.5, duration: 0.5, x: -1000})
      gsap.from('#user_list_display_btn',{opacity: 0.3, delay:0.75, duration: 1, x: -1000})
      gsap.from('#collaborate-btn',{opacity: 0.3, delay:1, duration: 1, x: -1000})
      gsap.from('#dropdown-scale',{opacity: 0.3, delay:1.25, duration: 1, x: -1000})
      gsap.from('#paper',{opacity: 0.3, duration: 1.5, x: 1000})
      gsap.from('#play-and-download',{opacity: 0.3, delay: 1, duration: 1, x: 1000})
      TweenLite.to('#logo', 2, {rotation:360, transformOrigin:"50% 50%", ease:Linear.easeNone,repeat:-1});
      function hiddenLink() {
        console.log(124);
        let link = document.getElementById("collab-popup-container");
        link.style = "display: none;";
      }
      let clipboard = new ClipboardJS("#collab-link-btn")
      clipboard.on('success', (event) => {
        event.clearSelection();
      });
      function displayLink() {
        let link = document.getElementById("collab-popup-container");
        link.style = "display: flex;";
      }
      function display(src) {
        let img = document.getElementById("scale-img");
        let dropdown = document.getElementById("dropdown-scale");
        
        img.src = src;
        img.style.display = "inline-block";
      }
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61474244-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      function displayParticipant() {
        let link = document.getElementById("user_list_all_container");
        link.style = "display: flex;";
      }
      function hideParticipant() {
        let link = document.getElementById("user_list_all_container");
        link.style = "display: none;";
      }
      function auto_grow(element) {
          element.style.height = (element.scrollHeight)+"px";
      }
      var abcjsEditor;

      window.onload = function () {
        
        let collab_link = document.getElementById("collab-link");
        collab_link.value = `${window.location.href}`
        abcjsEditor = new ABCJS.Editor("abc", {
          canvas_id: "paper",
          warnings_id: "warnings",
          synth: {
            el: "#audio",
            options: { displayLoop: true, displayRestart: true, displayPlay: true, displayProgress: true, displayWarp: true }
          },
          abcjsParams: {
            add_classes: true,
            clickListener: clickListener
          },
          selectionChangeCallback: selectionChangeCallback
        });

        document.getElementById("midi").addEventListener("click", downloadMidi);
      };

      function clickListener(abcElem, tuneNumber, classes, analysis, drag, mouseEvent) {
        var lastClicked = abcElem.midiPitches;
        if (!lastClicked)
          return;

        ABCJS.synth.playEvent(lastClicked, abcElem.midiGraceNotePitches, abcjsEditor.millisecondsPerMeasure()).then(function (response) {
          console.log("note played");
        }).catch(function (error) {
          console.log("error playing note", error);
        });
      }

      function selectionChangeCallback(start, end) {
        if (abcjsEditor) {
          var el = abcjsEditor.tunes[0].getElementFromChar(start);
          console.log(el);
        }
      }

      function downloadMidi() {
        var abc = document.getElementById("abc").value;
        var a = document.getElementById("midi-download");
        var midi = ABCJS.synth.getMidiFile(abc, { midiOutputType: "encoded" })
      a.setAttribute("href", midi)
      a.click();
    }
      $(document).ready(function() {
          $("#editor-and-scale").css({
            'height': ($("#paper-and-play").height() + 'px')
          });
          console.log($("#paper-and-play").height())
      });
      Pusher.logToConsole = true;
      const pusher = new Pusher(
        "f52f3e24526057845223",
        {
          cluster: "ap1",
          forceTLS: true,
          authEndpoint: "http://localhost:5000/pusher/auth",
        }
      );
      if (!document.cookie.match("(^|;) ?user_id=([^;]*)(;|$)")) {
        
        document.cookie = "user_id=" + prompt('Welcome to the channel. Please enter your name: ');
        document.querySelector('html').style = "display: block";
      } else {
        document.querySelector('html').style = "display: block";
      }
      let url = window.location.href;
      let channel_id = url.substring(url.lastIndexOf('=') + 1);
      const channel = pusher.subscribe(`presence-${channel_id}`);
      const hashCode = (s) =>
        s.split("").reduce((a, b) => {
          a = (a << 5) - a + b.charCodeAt(0);
          return a & a;
        }, 0);
      function addMemberToUserList(memberId) {
        userEl = document.createElement("div");
        userEl_name = document.createElement("div");
        userEl_name.innerText = memberId;
        console.log(memberId)
        userEl.id = "user_" + memberId;
        userEl.innerText = memberId[0].toUpperCase();
        userEl.style.backgroundColor =
          "hsl(" + (hashCode(memberId) % 360) + ",70%,60%)";
        document.getElementById("user_list").appendChild(userEl);
        document.getElementById("participants").appendChild(userEl_name);
      }
      channel.bind("pusher:subscription_succeeded", () =>
        channel.members.each((member) => addMemberToUserList(member.id))
      );
      channel.bind("pusher:member_added", (member) =>
        addMemberToUserList(member.id)
      );
      channel.bind("pusher:member_removed", (member) => {
        const userEl = document.getElementById("user_" + member.id);
        userEl.parentNode.removeChild(userEl);
      });
      console.log(channel);
      
    </script>
  </body>
</html>
